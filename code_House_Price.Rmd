---
title: "Ames house price"
output: html_document
---

NAME: Letizia Giordano 

BADGE: 789325

NICKNAME: l.giordano8 

TEAM: l.giordano8

ROUND: 1st


### Summary

1. Trasformare la variabile risposta SalePrice con log10

2. Ricodifico i livelli "" di alcune variabili fattoriali in NA

3. Assemblo l'informazione contenuta nella variabile Yr.Built e Yr.Remod.Add in una variabile che spiega se una casa è stata ristrutturata o meno. 

4. Imputo i dati mancanti delle variabili in base la media per le variabili numeriche,la moda per le variabili fattoriali o immaginando un loro ipotetico valore in base ai valori assunti da altre variabili a loro legate.

5. Eliminazione variabili con varianza quasi zero.

5. Tratto le variabili categoriali e numeriche separatamente.

6. Per le variabili numeriche, pre-processing: standardizzazione e trasformazione Box-Cox

7. Per le variabili fattoriali: codifica in dummy ed eliminazione di dummy a varianza quasi zero e combinazione lineare di altri variabili

8. Regressione Lasso



### References:

* Materiale e appunti delle lezioni "https://aldosolari.github.io/DM/"

* Pacchetto caret (http://topepo.github.io/caret/pre-processing.html) 

* Piattaforma Kaggle (https://www.kaggle.com/notaapple/detailed-exploratory-data-analysis-using-r#)

* Libro: "Introduction to Statistical Learning with Applications in R"

* Documentazione: http://bee-fore.s3-eu-west-1.amazonaws.com/datasets/62.txt

### Models

* Lasso

```{r startup, include = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = T, eval=T, message=F, warning=F, error=F, comment=NA, cache=F, R.options=list(width=220))
```

### R code to reproduce the last submission:
```{r}
library(caret)


#importazione dati
train <- read.csv("http://bee-fore.s3-eu-west-1.amazonaws.com/datasets/60.csv")
test <- read.csv("http://bee-fore.s3-eu-west-1.amazonaws.com/datasets/61.csv")
test$SalePrice=NA
n<-nrow(train)
m <- nrow(test)
combi<-rbind(train,test)


#codifica variabili e livelli
combi$MS.SubClass<-as.factor(combi$MS.SubClass)
combi$Overall.Qual<-as.factor(combi$Overall.Qual)
combi$Overall.Cond<-as.factor(combi$Overall.Cond)
combi$Mo.Sold<-as.factor(combi$Mo.Sold)


missing_levels <- function(colonna){

  levels(colonna) <- c(levels(colonna), 'NA')
  colonna <- relevel(colonna, ref = 'NA')
  colonna[is.na(colonna)] <-  'NA'
  return(colonna)

}

combi$Alley<-sapply(combi$Alley, missing_levels)
combi$Mas.Vnr.Type[combi$Mas.Vnr.Type==""] <- NA
combi$Bsmt.Qual<-sapply(combi$Bsmt.Qual, missing_levels)
combi$Bsmt.Qual[combi$Bsmt.Qual==""]<-NA
combi$Bsmt.Cond<-sapply(combi$Bsmt.Cond, missing_levels)
combi$Bsmt.Cond[combi$Bsmt.Cond==""]<-NA
combi$Bsmt.Exposure<-sapply(combi$Bsmt.Exposure, missing_levels)
combi$Bsmt.Exposure[combi$Bsmt.Exposure==""]<-NA
combi$BsmtFin.Type.1<-sapply(combi$BsmtFin.Type.1, missing_levels)
combi$BsmtFin.Type.1[combi$BsmtFin.Type.1==""]<-NA
combi$BsmtFin.Type.2<-sapply(combi$BsmtFin.Type.2, missing_levels)
combi$BsmtFin.Type.2[combi$BsmtFin.Type.2==""]<-NA
combi$Electrical[combi$Electrical==""]<-NA
combi$Fireplace.Qu<-sapply(combi$Fireplace.Qu, missing_levels)
combi$Garage.Type<-sapply(combi$Garage.Type, missing_levels)
combi$Garage.Finish<-sapply(combi$Garage.Finish, missing_levels)
combi$Garage.Finish[combi$Garage.Finish==""]<-NA
combi$Garage.Qual<-sapply(combi$Garage.Qual, missing_levels)
combi$Garage.Qual[combi$Garage.Qual==""]<-NA
combi$Garage.Cond<-sapply(combi$Garage.Cond, missing_levels)
combi$Garage.Cond[combi$Garage.Cond==""]<-NA
combi$Pool.QC<-sapply(combi$Pool.QC, missing_levels)
combi$Fence<-sapply(combi$Fence, missing_levels)
combi$Misc.Feature<-sapply(combi$Misc.Feature, missing_levels)

#ricodifica variabile Yr.Built e Yr.Remod
c<-dim(combi)[1]
for (i in 1:c){
if (combi$Year.Built[i]==combi$Year.Remod.Add[i]) combi$Remodel[i]="Remod" else combi$Remodel[i]="NoRemod"}
combi$Remodel<-as.factor(combi$Remodel)

#eliminazione variabili Yr.Built, Y.Remod e Garage.Yr.Built
combi<-combi[,-c(1,2,21,22,61)] 

#imputazione dati mancanti in base la media, moda e/o in base i valori assunti da altre variabii
combi$Lot.Frontage[which(is.na(combi$Lot.Frontage))]<-69
combi$Bsmt.Half.Bath[which(is.na(combi$Bsmt.Half.Bath))]<-0
combi$Bsmt.Full.Bath[which(is.na(combi$Bsmt.Full.Bath))]<-0
combi$Electrical[which(is.na(combi$Electrical))]<-factor("SBrkr")
combi$Mas.Vnr.Type[which(is.na(combi$Mas.Vnr.Type))]<-factor("None")
combi$Bsmt.Exposure[which(is.na(combi$Bsmt.Exposure))]<-factor("No")
combi$Mas.Vnr.Area[which(is.na(combi$Mas.Vnr.Area))]<-102
#combi[which(is.na(combi$Garage.Qual)), ]
combi$Garage.Qual[which(is.na(combi$Garage.Qual))]<-factor("NA")
combi$Garage.Cond[which(is.na(combi$Garage.Cond))]<-factor("NA")
combi$Garage.Finish[which(is.na(combi$Garage.Finish))]<-factor("NA")
combi$Garage.Area[which(is.na(combi$Garage.Area))]<-0 #perchè non c'è nessun garage
#combi[which(is.na(combi$Garage.Cars)), ]
combi$Garage.Cars[which(is.na(combi$Garage.Cars))]<-0
#combi[which(is.na(combi$Bsmt.Qual)),]
combi$Bsmt.Qual[which(is.na(combi$Bsmt.Qual))]<-factor("TA")
combi$Bsmt.Cond[which(is.na(combi$Bsmt.Cond))]<-factor("TA")
#combi[which(is.na(combi$BsmtFin.Type.1)),]
combi$BsmtFin.Type.1[which(is.na(combi$BsmtFin.Type.1))]<-factor("GLQ")
combi$BsmtFin.Type.2[which(is.na(combi$BsmtFin.Type.2))]<-factor("Unf")
#combi[which(is.na(combi$BsmtFin.SF.1)),]
combi$BsmtFin.SF.1[which(is.na(combi$BsmtFin.SF.1))]<-443
combi$BsmtFin.SF.2[which(is.na(combi$BsmtFin.SF.2))]<-50
#combi[which(is.na(combi$Total.Bsmt.SF)),]
#aggregate(combi$Total.Bsmt.SF~combi$BsmtFin.Type.1+combi$BsmtFin.Type.2, FUN=mean)
combi$Total.Bsmt.SF[which(is.na(combi$Total.Bsmt.SF))]<-0
#combi[which(is.na(combi$Bsmt.Unf.SF)),]
#aggregate(combi$Bsmt.Unf.SF~combi$BsmtFin.Type.1+combi$BsmtFin.Type.2, FUN=mean)
combi$Bsmt.Unf.SF[which(is.na(combi$Bsmt.Unf.SF))]<-559


#eliminazione variaibli nearZeroVariance
var_nzv <- nearZeroVar(combi)
combi<-combi[,-var_nzv]

#trattazione variabili numeriche e categoriali separatamente
#variabili numeriche
vars <- setdiff(names(combi),"SalePrice")
vars_num<- vars[sapply(combi[,vars],class) %in% c('numeric','integer')]
combi_num=combi[,vars_num]

#pre-process sulle variabili numeriche
preProcValues <- preProcess(combi_num, method = c("center", "scale","BoxCox"))
var_num_Transformed <- predict(preProcValues, combi_num)

combi_num1<-var_num_Transformed

#variabili categoriali
vars_cat <- vars[sapply(combi[,vars],class) %in% c('factor','logical')]
combi_fact<-combi[,vars_cat]
train_fac<-combi_fact[1:n,]
train_fac$SalePrice<-train$SalePrice

#Trasorfmo le varaibili categoriali in dummy per gestire tanti livelli
var_dum=dummyVars(~.,combi_fact)
dummy=data.frame(predict(var_dum,combi_fact))

#Elimino le variabii con nearZeroVariance con questa nuova ricodifica
dum_nzs<-nearZeroVar(dummy)
dummy<-dummy[,-dum_nzs]

#valuto se ci sono variabili l'una una combinazione lineare dall'altra e le elimino
LinearCombo<-findLinearCombos(dummy)

dummy<-dummy[,-LinearCombo$remove]
dummy$SalePrice<-combi$SalePrice

#ritono al dataset iniziale
combi<-cbind(combi_num1,dummy) 
train = combi[1:n,]
test = combi[(n+1):nrow(combi),]


#preparo le matrici del disegno per la regressione lasso
x_tr<-train[,-129]
x_te<-test[,-129] 

#modello lasso con k-fold cross-validation
rcv <- trainControl(method="repeatedcv",
                                 number=10,
                                 repeats=2
                                )
y<-log10(train$SalePrice)
set.seed(123) 
model_lasso <- train(x=x_tr,y=y,
                     method="glmnet",
                     metric="RMSE",
                     maximize=FALSE,
                     trControl=rcv)

yhat=10^predict(model_lasso,newdata=x_te)
head(yhat)
```



